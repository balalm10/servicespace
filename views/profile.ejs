<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('./partials/common_header.ejs') %>

    <link rel="stylesheet" href="css/profile.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
</head>

<body>
    <%- include('./partials/scripts.ejs') %>
    <%- include('./partials/navbar.ejs', {isLoggedIn: iLog}); %>
    <%- include('./partials/messages.ejs'); %>

    <div class="container">
        <div class="main-body">
            <div class="row gutters-sm">
                <div class="col-md-4 mt-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex flex-column align-items-center text-center">
                                <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Admin"
                                    class="rounded-circle" width="150">
                                <div class="mt-3">
                                    <h4><%= user.name %></h4>
                                    <p class="text-secondary mb-1"><%= user.username %></p>
                                    <p class="text-muted font-size-sm"><%= user.utype %></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="social-media-card-outer" class="col-md-8 mt-3">
                    <div id="social-media-card-inner" class="card h-100">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                <h6 class="mb-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="feather feather-globe mr-2 icon-inline">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="2" y1="12" x2="22" y2="12"></line>
                                        <path
                                            d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                                        </path>
                                    </svg>
                                    Website
                                </h6>
                                <div>
                                    <% if (user.social_media && user.social_media.website) { %>
                                    <a target="_blank" id="websiteLink"
                                        href="<%= user.social_media.website %>"><%= user.social_media.website %></a>
                                    <% } else { %>
                                    <small class="text-secondary text-muted font-italic">Not Linked</small>
                                    <% } %>
                                    <a id="websiteEdit" class="btn btn-sm btn-outline btn-social-media p-0 m-0 ml-2">
                                        <i class="bi-pencil-fill"></i>
                                    </a>
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                <h6 class="mb-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round"
                                        class="feather feather-linkedin mr-2 icon-inline text-primary">
                                        <path
                                            d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z">
                                        </path>
                                        <rect x="2" y="9" width="4" height="12"></rect>
                                        <circle cx="4" cy="4" r="2"></circle>
                                    </svg>LinkedIn</h6>
                                <div>
                                    <% if (user.social_media && user.social_media.linkedin) { %>
                                    <a target="_blank" id="linkedInLink"
                                        href="https://www.linkedin.com/in/<%= user.social_media.linkedin %>"><%= user.social_media.linkedin %></a>
                                    <% } else { %>
                                    <small class="text-secondary text-muted font-italic">Not Linked</small>
                                    <% } %>
                                    <a id="linkedInEdit" class="btn btn-sm btn-outline btn-social-media p-0 m-0 ml-2">
                                        <i class="bi-pencil-fill"></i>
                                    </a>
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                <h6 class="mb-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round"
                                        class="feather feather-twitter mr-2 icon-inline text-info">
                                        <path
                                            d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z">
                                        </path>
                                    </svg>Twitter</h6>
                                <div>
                                    <% if (user.social_media && user.social_media.twitter) { %>
                                    <a target="_blank" id="twitterink"
                                        href="https://twitter.com/<%= user.social_media.twitter %>"><%= user.social_media.twitter %></a>
                                    <% } else { %>
                                    <small class="text-secondary text-muted font-italic">Not Linked</small>
                                    <% } %>
                                    <a id="twitterEdit" class="btn btn-sm btn-outline btn-social-media p-0 m-0 ml-2">
                                        <i class="bi-pencil-fill"></i>
                                    </a>
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                <h6 class="mb-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round"
                                        class="feather feather-instagram mr-2 icon-inline text-danger">
                                        <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                                        <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                                        <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                                    </svg>Instagram</h6>
                                <div>
                                    <% if (user.social_media && user.social_media.instagram) { %>
                                    <a target="_blank" id="instagramLink"
                                        href="https://www.instagram.com/<%= user.social_media.instagram %>"><%= user.social_media.instagram %></a>
                                    <% } else { %>
                                    <small class="text-secondary text-muted font-italic">Not Linked</small>
                                    <% } %>
                                    <a id="instagramEdit" class="btn btn-sm btn-outline btn-social-media p-0 m-0 ml-2">
                                        <i class="bi-pencil-fill"></i>
                                    </a>
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                <h6 class="mb-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round"
                                        class="feather feather-facebook mr-2 icon-inline text-primary">
                                        <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z">
                                        </path>
                                    </svg>Facebook</h6>
                                <div>
                                    <% if (user.social_media && user.social_media.facebook) { %>
                                    <a target="_blank" id="facebookLink"
                                        href="https://www.facebook.com/<%= user.social_media.facebook %>"><%= user.social_media.facebook %></a>
                                    <% } else { %>
                                    <small class="text-secondary text-muted font-italic">Not Linked</small>
                                    <% } %>
                                    <a id="facebookEdit" class="btn btn-sm btn-outline btn-social-media p-0 m-0 ml-2">
                                        <i class="bi-pencil-fill"></i>
                                    </a>
                                </div>
                            </li>

                            <!-- Official Mail and Official Phone displayed for service providers -->

                            <% if (user.utype === 'Service Provider') { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                <h6 class="mb-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round"
                                        class="feather feather-mail mr-2 icon-inline">
                                        <path
                                            d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z">
                                        </path>
                                        <polyline points="22,6 12,13 2,6"></polyline>
                                    </svg>Official Mail</h6>
                                <span class="text-secondary"><%= user.spdetails.email %></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                <h6 class="mb-0"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round"
                                        class="feather feather-phone mr-2 icon-inline">
                                        <path
                                            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
                                        </path>
                                    </svg>Official Phone</h6>
                                <span class="text-secondary"><%= user.spdetails.phone %></span>
                            </li>
                            <% } %>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Services Offered, only displayed for service providers -->

            <div class="row gutters-sm">
                <div class="col mb-3 mt-3">
                    <div class="card h-100">
                        <div class="card-header container-fluid">
                            <% if (user.utype === 'Service Provider') { %>
                            <h3 class="float-left">Services Offered</h3>
                            <button type="button" class="btn btn-outline-success float-right" data-toggle="modal"
                                data-target="#addServiceModal">Add</button>
                            <% } else { %>
                            <h3 class="float-left">Watch List</h3>
                            <% } %>
                        </div>
                        <div class="card-body align-items-center container-fluid">
                            <div class="d-flex mb-3">
                                <ul class="list-group list-group-flush w-100 services-list">
                                    <!-- Services will be added via ajax -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Add Service Modal -->

    <div class="modal fade" id="addServiceModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addServiceModalTitle">Details of service offered</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group form-row">
                        <div class="col">
                            <input type="text" class="form-control" id="serviceName" placeholder="Service Name" />
                        </div>
                    </div>
                    <div class="form-group form-row">
                        <div class="col">
                            <input type="text" class="form-control" id="serviceDesc" placeholder="Description" />
                        </div>
                    </div>
                    <div class="form-group form-row">
                        <div class="col">
                            <div class="input-group">
                                <input type="number" class="form-control" id="serviceFee" placeholder="Fee" />
                                <div class="input-group-append">
                                    <span class="input-group-text pl-2 pr-2" id="rupee-addon">&#8377;</span>
                                    <button class="btn btn-outline-secondary dropdown-toggle" id="rate-dropdown-button"
                                        type="button" data-toggle="dropdown">/ hour</button>
                                    <div class="dropdown-menu" id="rate-dropdown-menu">
                                        <a class="dropdown-item" href="#">/ hour</a>
                                        <a class="dropdown-item" href="#">/ day</a>
                                        <a class="dropdown-item" href="#">/ job</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary add-service-btn" data-dismiss="modal">
                        Add Service</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Link social media modal -->

    <div class="modal fade" id="addSocialMediaModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSocialMediaModalTitle">Update Social Media info</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group form-row">
                        <div class="col">
                            <input type="text" class="form-control" id="social-media-value"
                                placeholder="Enter URL or Username" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary add-social-media-btn"
                        data-dismiss="modal">Link</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $("#rate-dropdown-menu a").click(function () {
            let val = $(this).text()
            $("#rate-dropdown-button").html(val);
        });

        $("#social-media-card-outer").on("click", ".btn-social-media", function () {
            let id = $(this).attr("id")
            let name = id.replace('Edit', '')
            let modal = $("#addSocialMediaModal")

            modal.find('.modal-header h5').text(`Update ${name}`)
            modal.find('.modal-body div div input')
                .attr("placeholder", (name === 'website') ? 'Enter website URL' :
                    `Enter ${name} handle / profile URL`)

            $("#addSocialMediaModal").modal('show')
        });

        $("button.add-social-media-btn").click(function () {
            let name = $("#addSocialMediaModalTitle").text().replace('Update', '').trim().toLowerCase()
            let value = $("#social-media-value").val()
            $("#social-media-value").val('')

            if (name != 'website') {
                value = value.replace(/.*\.com/g, '')
                value = value.replace(/\/in\//g, '')
                value = value.replace(/\//g, '')
            }

            $.ajax({
                url: `/socialmedia/${name}`,
                method: 'put',
                dataType: 'json',
                data: {
                    'handle': value
                },
                success: function (response) {
                    if (!response.error) {
                        console.log(response.message)
                        $("#social-media-card-inner").load(window.location.href +
                            " #social-media-card-inner");
                    } else {
                        console.log('error', response.message)
                    }
                },
                error: function (response) {
                    alert('server error occured')
                }
            });
        });

        $(document).ready(function () {

            // Initial data load
            fetchServices();

            $('button.add-service-btn').click(function () {
                // Get values
                let name = $("#serviceName").val();
                let desc = $("#serviceDesc").val();
                let fee = $("#serviceFee").val();
                let fee_t = $("#rate-dropdown-button").html().trim();

                // reset fields
                $("#serviceName").val('');
                $("#serviceDesc").val('');
                $("#serviceFee").val('');

                $.ajax({
                    url: '/service/create',
                    method: 'post',
                    dataType: 'json',
                    data: {
                        'name': name,
                        'desc': desc,
                        'fee': fee,
                        'fee_t': fee_t
                    },
                    success: function (response) {
                        if (!response.error) {
                            console.log(response.message)
                            populateServices(response.message);
                        } else {
                            console.log('error', response.message)
                        }
                    },
                    error: function (response) {
                        alert('server error occured')
                    }
                });
            });

            $(document).on('click', 'button.remove-service-btn', function () {

                var id = $(this).attr('id')
                let utype = '<%= (iLog && user) ? user.utype : "Guest" %>'

                if (utype === 'Customer') {
                    $.ajax({
                        url: 'service/removefromwl',
                        method: 'delete',
                        dataType: 'json',
                        data: {
                            'service_id': id
                        },
                        success: function (response) {
                            console.log('Remove Service from watchlist', response);
                            if (!response.error) {
                                console.log('Service removed from watchlist');
                                populateServices(response.message)
                            } else {
                                console.log('Unable to remove from watchlist:', response
                                    .message);
                            }
                        },
                        error: function (response) {
                            alert('server error occured')
                        }
                    });
                } else {
                    $.ajax({
                        url: '/service/remove',
                        method: 'delete',
                        dataType: 'json',
                        data: {
                            'service_id': id
                        },
                        success: function (response) {
                            console.log('Remove Service Response', response);
                            if (!response.error) {
                                console.log('Service Removed');
                                populateServices(response.message);
                            } else {
                                console.log('Unable to remove service', response.message);
                            }
                        },
                        error: function (response) {
                            alert('server error occured')
                        }
                    });
                }

            });

            function fetchServices() {

                console.log('fetching services from server')
                let userid = '<%- user._id %>'
                console.log(userid)

                $.ajax({
                    url: `/service/getservices/${userid}`,
                    method: 'get',
                    success: function (response) {
                        console.log('Got response success', response)
                        if (!response.error) {
                            populateServices(response.message)
                        }
                    },
                    error: function (response) {
                        console.log('Server error while fetching services')
                    }
                });
            }

            function populateServices(services) {

                console.log('services', services)

                $('.services-list').empty()

                let utype = '<%- user.utype %>'

                if (services == undefined || services == null || services.length == 0) {
                    let default_msg = (utype === 'Customer') ?
                        "Add services to your watchlist from the feed to have quick access to them!" :
                        "The services you provide will be listed here, create one right now!";
                    $('.services-list').append(
                        `<li class="list-group-item text-muted">${default_msg}</li>`
                    );
                } else {
                    services.forEach(service => {
                        $('.services-list').append(
                            `<li class="list-group-item">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="card-title">${service.name}</h4>
                                        <p class="card-text">${service.desc}</p>
                                        <h5 class="float-left">&#8377; &nbsp; ${service.fee} ${service.fee_t}</h5>
                                        <button type="button" style="float: right;"
                                            class="btn btn-danger remove-service-btn" id="${service._id}">Remove</button>
                                    </div>
                                </div>
                            </li>`
                        )
                    });
                }
            }
        });

    </script>
</body>

</html>
